(()=>{"use strict";var e={730:(e,t)=>{}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}(()=>{r(730);function e(e,t){if(!e)throw new Error("function"==typeof t?t():t)}var t=class extends Error{constructor(e){super(`offset (${e.idx}) is not equal to array bytes length (${e.u8.byteLength})`)}},n=class{static encode(e,t){const r=new n(new Uint8Array(t.sizeHint(e)));return t(e,r),r.checkFinalOffset(),r.u8}static decode(e,t){const r=new n(e),o=t(r);return r.checkFinalOffset(),o}u8;view;idx=0;constructor(e){if(!ArrayBuffer.isView(e))throw new Error(`Passed source is not an ArrayBufferView (${String(e)})`);this.u8=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.view=new DataView(e.buffer,e.byteOffset,e.byteLength)}checkFinalOffset(){if(this.idx!==this.u8.byteLength)throw new t(this)}setOffset(e){return this.idx=e,this}};function o(e,t){return e.sizeHint=t,e}o((()=>{}),(()=>0));var i=o(((e,t)=>{t.u8[t.idx++]=e?1:0}),(()=>1)),s={i8:1,u8:1,i16:2,u16:2,i32:4,u32:4,i64:8,u64:8,i128:16,u128:16,i256:32,u256:32,i512:64,u512:64},a=e=>()=>s[e],u=e=>8===s[e],c=e=>s[e]<=4,d=e=>"i"===e[0];function l(t,r){const n=t<0,o=d(r);return e(!n||o,(()=>`Negative num (${t}) is passed to unsigned ("${r}") encoder`)),n}function f(t,r,n){l(t,r),e(Number.isSafeInteger(t),(()=>`Unsafe integer (${t}) is passed into encoder`));const{view:o,idx:i}=n;switch(r){case"i8":o.setInt8(i,t);break;case"u8":o.setUint8(i,t);break;case"i16":o.setInt16(i,t,!0);break;case"u16":o.setUint16(i,t,!0);break;case"i32":o.setInt32(i,t,!0);break;case"u32":o.setUint32(i,t,!0)}n.idx+=s[r]}function g(e,t){const{view:r,idx:n}=e;let o;switch(t){case"i8":o=r.getInt8(n);break;case"u8":o=r.getUint8(n);break;case"i16":o=r.getInt16(n,!0);break;case"u16":o=r.getUint16(n,!0);break;case"i32":o=r.getInt32(n,!0);break;case"u32":o=r.getUint32(n,!0)}return e.idx+=s[t],o}function h(e,t,r,n){let o=0;for(;e>0&&o<n;)t[r+o++]=Number(0xffn&e),e>>=8n;if(e>0)throw new Error(`Number ${e} is out of bytes limit (${n})`);return o}function p(e,t,r){if(c(t))return f(Number(e),t,r);if(u(t))return function(e,t,r){l(e,t);const{view:n,idx:o}=r;switch(t){case"u64":n.setBigUint64(o,e,!0);break;case"i64":n.setBigInt64(o,e,!0)}r.idx+=s[t]}(e,t,r);const n=l(e,t),o=s[t];n&&(e=BigInt.asUintN(8*o,e)),h(e,r.u8,r.idx,o),r.idx+=o}function b(e,t,r){let n=r&&(128&e.u8[e.idx+t-1])>>7==1,o=0n;for(let r=0,n=0n;r<t;r++,n+=8n)o+=BigInt(e.u8[e.idx+r])<<n;return n&&(o=BigInt.asIntN(8*t,o)),o}function w(e,t){if(c(t))return BigInt(g(e,t));if(u(t))return function(e,t){const{view:r,idx:n}=e;let o;switch(t){case"u64":o=r.getBigUint64(n,!0);break;case"i64":o=r.getBigInt64(n,!0)}return e.idx+=s[t],o}(e,t);const r=d(t),n=s[t],o=b(e,n,r);return e.idx+=n,o}function y(e){return o(((t,r)=>f(t,e,r)),a(e))}function N(e){return t=>g(t,e)}function x(e){return o(((t,r)=>p(t,e,r)),a(e))}function T(e){return t=>w(t,e)}y("u8"),N("u8"),y("i8"),N("i8"),y("u16");var k=N("u16"),$=(y("i16"),N("i16"),y("u32")),m=N("u32"),F=(y("i32"),N("i32"),x("u64"),T("u64"),x("i64"),T("i64"),x("u128")),I=(T("u128"),x("i128"),T("i128"),2**30-1);function B(e){const t=e.u8[e.idx];switch(3&t){case 0:return e.idx++,BigInt(t>>2);case 1:return w(e,"u16")>>2n;case 2:return w(e,"u32")>>2n;default:{const r=4+(t>>2);e.idx++;const n=b(e,r,!1);return e.idx+=r,n}}}var v=(e,t)=>{if(!(e>=0)||!Number.isInteger(e)&&"bigint"!=typeof e)throw new Error(`Invalid number is passed: ${e}. It should be non-negative integer.`);if(e<=63)return void(t.u8[t.idx++]=Number(e)<<2);if(e<=16383)return void p((BigInt(e)<<2n)+1n,"u16",t);if(e<=I)return void p((BigInt(e)<<2n)+2n,"u32",t);const r=h(BigInt(e),t.u8,t.idx+1,1/0);t.u8[t.idx]=3+(r-4<<2),t.idx+=1+r};function P(e,t,r){const n=new Array(r);for(let o=0;o<r;o++)n[o]=t(e);return n}v.sizeHint=function(e){return e<=63?1:e<=16383?2:e<=I?4:1+function(e){let t=0;for(;e>0;)t++,e>>=8n;return t}(BigInt(e))};o(((e,t)=>{v(e.byteLength,t),t.u8.set(e,t.idx),t.idx+=e.byteLength}),(e=>v.sizeHint(e.byteLength)+e.byteLength));var O=new TextEncoder,S=new TextDecoder("utf-8",{fatal:!0});function A(e){let t=e.length;for(let r=e.length-1;r>=0;r--){const n=e.charCodeAt(r);n>127&&n<=2047?t++:n>2047&&n<=65535&&(t+=2),n>=56320&&n<=57343&&r--}return t}var R=o(((e,t)=>{const r=A(e);v(r,t);const n=O.encodeInto(e,t.u8.subarray(t.idx));if(n.written!==r)throw new Error(`SCALE internal error: counting of string bytes length is incorrect; string: "${e}"; actual bytes length: ${n.written}; computed: ${r}; please report a bug.`);t.idx+=r}),(e=>{const t=A(e);return t+v.sizeHint(t)}));o(((e,t)=>{t.u8[t.idx++]="None"===e.tag?0:e.content?1:2}),(()=>1));const C=(q=[["era",m],["nbWinners",k],["excluded",(U=function(e){const t=(e=>{const t=Number(B(e)),r=e.u8.slice(e.idx,e.idx+t);return e.idx+=t,r})(e);return S.decode(t)},e=>function(e,t){const r=B(e);return P(e,t,Number(r))}(e,U))]],e=>function(e,t){const r={};for(let n=0,o=t.length,i=null;n<o;n++)i=t[n],r[i[0]]=i[1](e);return r}(e,q));var q,U;const D=(E=[["era",$],["skipped",i],["rewards",F],["winners",(H=R,o(((e,t)=>function(e,t,r){v(BigInt(e.length),r);for(const n of e)t(n,r)}(e,H,t)),(e=>function(e,t){let r=v.sizeHint(e.length);for(let n=e.length-1;n>=0;n--)r+=t.sizeHint(e[n]);return r}(e,H))))]],o(((e,t)=>function(e,t,r){for(let n=0,o=t.length,i=null;n<o;n++)i=t[n],i[1](e[i[0]],r)}(e,E,t)),(e=>function(e,t){let r=0;for(let n=t.length-1,o=null;n>=0;n--)o=t[n],r+=o[1].sizeHint(e[o[0]]);return r}(e,E))));var E,H,L;function z(e){for(var t="",r=0;r<e.length;r++)t+=e.charCodeAt(r).toString(16);return"0x"+t}function J(e,t){return null==t?e:e.filter(((e,r)=>!t.includes(e.address)))}function M(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].nbTickets;if(0==t)throw L.NoMoreParticipant;const r=Math.floor(Math.random()*t+1);let n=0;for(let t=0;t<e.length;t++)if(n+=e[t].nbTickets,n>=r)return e[t].address;throw L.NoWinnerFound}function G(e){return n.encode(e,D)}!function(e){e.FailedToDecodeInput="FailedToDecodeInput",e.FailedToFetchReward="FailedToFetchReward",e.FailedToDecodeReward="FailedToDecodeReward",e.NoReward="NoReward",e.FailedToFetchParticipant="FailedToFetchParticipant",e.FailedToDecodeParticipant="FailedToDecodeParticipant",e.NoMoreParticipant="NoMoreParticipant",e.NoWinnerFound="NoWinnerFound",e.NoBlockNumber="NoBlockNumber",e.NoPeriod="NoPeriod"}(L||(L={})),globalThis.scriptOutput=function(e,t){console.log(`Request : ${e}`);const r=function(e){let t=e.toString();if(!/^0x[0-9a-f]+$/.test(t.toLowerCase()))throw L.FailedToDecodeInput;t=t.slice(2);let r=new Array,o=0;for(let e=0;e<t.length;e+=2)r[o++]=parseInt(t.substring(e,e+2),16);return n.decode(new Uint8Array(r),C)}(e),o=r.era,i=r.nbWinners,s=r.excluded;console.log(`Era ${o} - select ${i} address(es) excluding [${s}]`),console.log(`Settings: ${t}`);const a=t;try{const e=function(e,t){const r={"Content-Type":"application/json","User-Agent":"phat-contract"},n=z(JSON.stringify({query:`query {dAppStakingEras(filter: {era: {equalTo: "${t}"}}){nodes{ era, blockNumber}}}`})),o=pink.batchHttpRequest([{url:e,method:"POST",headers:r,body:n,returnTextBody:!0}],1e4)[0];if(200!==o.statusCode)throw console.log(`Fail to read Graph api for rewards with status code: ${o.statusCode}, error: ${o.error||o.body}}`),L.FailedToFetchReward;const i=o.body;if("string"!=typeof i)throw L.FailedToDecodeReward;const s=JSON.parse(i).data.dAppStakingEras.nodes[0];if(null==s||null==s.blockNumber||0==s.blockNumber)throw console.log(`No Block Number: ${s}`),L.NoBlockNumber;const a=s.blockNumber;console.log(`Block Number for era ${s.era}: ${a}`);const u=z(JSON.stringify({query:`query {dAppSubPeriods(filter: {blockNumber: {lessThanOrEqualTo: "${a}"}}, first: 1, orderBy: BLOCK_NUMBER_DESC){nodes{ period, subPeriod, blockNumber}}}`})),c=pink.batchHttpRequest([{url:e,method:"POST",headers:r,body:u,returnTextBody:!0}],1e4)[0];if(200!==c.statusCode)throw console.log(`Fail to read Graph api for rewards with status code: ${c.statusCode}, error: ${c.error||c.body}}`),L.FailedToFetchReward;const d=c.body;if("string"!=typeof d)throw L.FailedToDecodeReward;const l=JSON.parse(d).data.dAppSubPeriods.nodes[0];if(null==l||null==l.period||0==l.period)throw console.log(`No Period: ${l}`),L.NoPeriod;const f=l.period,g=l.subPeriod;return console.log(`Period ${f} and sub-period ${g} for era ${t}`),{era:t.valueOf(),period:f,subPeriod:g}}(a,o);if("VOTING"==e.subPeriod.toUpperCase()){const e={era:Number(o.toString()),skipped:!0,rewards:BigInt(0),winners:[]};return console.log(`Voting subPeriod for era: ${e.era} => skip the raffle`),G(e)}const t=e.period,r=function(e,t){const r=z(JSON.stringify({query:`query {dAppRewards(filter: { era: { equalTo: "${t}"  } }) {nodes {amount, era}}}`})),n=pink.batchHttpRequest([{url:e,method:"POST",headers:{"Content-Type":"application/json","User-Agent":"phat-contract"},body:r,returnTextBody:!0}],1e4)[0];if(200!==n.statusCode)throw console.log(`Fail to read Graph api for rewards with status code: ${n.statusCode}, error: ${n.error||n.body}}`),L.FailedToFetchReward;const o=n.body;if("string"!=typeof o)throw L.FailedToDecodeReward;const i=JSON.parse(o).data.dAppRewards.nodes[0];if(null==i||null==i.amount||0==i.amount)throw console.log(`No rewards: ${i}`),L.NoReward;return i.amount}(a,o);let n=function(e,t,r){const n=z(JSON.stringify({query:`query { stakes(filter: {and: [ {period: {equalTo: "${t}"}}, {era: {lessThan: "${r}"}}]}) {groupedAggregates(groupBy: [ACCOUNT_ID], having: { sum: { amount: { notEqualTo: "0" }}}) { sum{amount}, keys }}}`})),o=pink.batchHttpRequest([{url:e,method:"POST",headers:{"Content-Type":"application/json","User-Agent":"phat-contract"},body:n,returnTextBody:!0}],1e4)[0];if(200!==o.statusCode)throw console.log(`Fail to read Graph api with status code: ${o.statusCode}, error: ${o.error||o.body}}`),L.FailedToFetchParticipant;const i=o.body;if("string"!=typeof i)throw L.FailedToDecodeParticipant;let s=[];const a=JSON.parse(i).data.stakes.groupedAggregates,u=BigInt(5e14);for(let e=0;e<a.length;e++){const t=a[e].keys[0],r=a[e].sum,n=BigInt(parseFloat(r.amount))/u;s.push({address:t,nbTickets:Number(n)})}return console.log(`Number of participants: ${s.length}`),s}(a,t,o);n=J(n,s);let u=[];for(let e=0;e<i;e++){const e=M(n);u.push(e),n=J(n,[e])}const c={era:Number(o.toString()),skipped:!1,rewards:BigInt(r.valueOf()),winners:u};return console.log(`winners: ${c.winners}`),console.log(`Rewards: ${c.rewards}`),G(c)}catch(e){throw console.log("error:",e),e}}.apply(null,globalThis.scriptArgs)})()})();